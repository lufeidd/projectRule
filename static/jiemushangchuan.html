<!DOCTYPE html>
<html>

<head>
    <title>总览-火把知识</title>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="stylesheet" type="text/css" href="layui-2.0/css/layui.css">
    <link rel="stylesheet" type="text/css" href="layui-2.0/webuploader/webuploader.css">
    <!-- 样式重定义 -->
    <link rel="stylesheet" type="text/css" href="layui-2.0/css/public.css">
    <!-- 字体图标 -->
    <script src="layui-2.0/font/iconfont.js"></script>
</head>
<style>
    .titleTop{
        margin-bottom: 15px;
        color:#333333;
        font-size: 14px;
        font-weight: bold;
    }
    .etc-picture{
        font-size: 14px;
        font-family:PingFang SC;
    }
    .etc-picture .prompt{
        color: #999999;
        flex-shrink: 0;
    }
    .etc-picture .etcName{
        color:  #333333;
    }
    .df{
        display: flex;
    }
    .uploadFile{
        margin-top: 15px;
    }
    .uploadFile .uploadTitle{
        color: #333333;
        font-size: 14px;
        display: inline-block;
    }
    .uploadFile .layui-btn-warm{
        display: inline-block;
    }
    .uploadFile .uploadPro{
        color: #999999;
        font-size: 12px;
        margin-left: 100px;
        margin-top: 10px;
    }
    .uploadContent{
        margin-top: 30px;
        margin-left: 100px;
    }
    .uploadContent .list{
        border: 1px solid #E3E3E3;
        padding: 10px;
        font-size: 12px;
        line-height: 18px;
        width: 65%;
        float: left;
        margin-bottom: -1px;
        margin-right: -1px;
    }
    .uploadContent .list .tally{
        color: #333333;
        align-items: center;
        justify-content: center;
        display: flex;
        width: 19px;
    }
    .uploadContent .list .etcContent{
        color: #333333;
        padding-left: 5px;
        flex-basis: 70%;
    }
    .uploadContent .list .area{
        color: #999999;
        flex-grow: 1;
    }
    .uploadContent .list .uploadText{
        color: #333333;
        flex-shrink: 0;
    }
    .webuploader-pick{
         background: none;
         padding: 0;
         color: #333333;
    }
    .webuploader-pick:hover {
        background: none;
    }
</style>
<body class="large">
<script>
    if (localStorage.getItem('slideState') == 'small') {
        document.querySelector('body').setAttribute('class', 'small');
    } else {
        document.querySelector('body').setAttribute('class', 'large');
    }
</script>
<div class="layui-layout layui-layout-admin">
    <!-- 供应商logo -->
    <div class="layui-logo">
        <img src="layui-2.0/images/logo.png" width="26px" height="27px">
        <span class="slogan">火把知识服务平台</span>
        <div class="foldAction">
            <i class="layui-icon layui-icon-shrink-right"></i>
            <i class="layui-icon layui-icon-spread-left"></i>
        </div>
    </div>

    <!-- 头部 栏目 -->
    <div class="layui-header">
        <!-- 头部导航栏右边部分 -->
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="#">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#iconmessage-line"></use>
                    </svg>
                    <span>私信</span>
                    <span class="layui-badge-dot"></span>
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="#">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#iconnews-line"></use>
                    </svg>
                    <span>通知中心</span>
                    <span class="layui-badge-dot"></span>
                </a>
            </li>
            <li class="layui-nav-item ">
                <a href="#">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#iconhelp-line"></use>
                    </svg>
                    <span>帮助中心</span>
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="#">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    <span>用户名</span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="#">账号主页</a></dd>
                    <dd><a href="#">修改密码</a></dd>
                    <dd><a class="logout" href="#">退出登录</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <!-- 侧边栏部分 -->
    <!-- 展开 -->
    <div class="layui-side layui-bg-black large">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="#">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#iconoverview-block"></use>
                        </svg>
                        <span>总览</span>
                    </a>
                </li>
                <li class="layui-nav-item layui-nav-itemed">
                    <a href="#">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#iconsource-block"></use>
                        </svg>
                        <span>发布管理</span>
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="#">文章列表</a></dd>
                        <dd class="layui-this"><a href="#">专辑列表</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>
    <!-- 收起 -->
    <div class="layui-side layui-bg-black small">
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="#">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#iconoverview-block"></use>
                    </svg>
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="#">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#iconsource-block"></use>
                    </svg>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="#">文章列表</a></dd>
                    <dd><a href="#">专辑列表</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <!-- 面包屑 -->
    <div class="breadcrumb-container">
            <span class="layui-breadcrumb">
                <a href="/">首页</a>
                <a href="/frame.html">框架</a>
                <a><cite>导航元素</cite></a>
            </span>
    </div>
    <!-- 主体内容 -->
    <div class="layui-body">
        <div style="height: auto;">
            <div>
                <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                    <ul class="layui-tab-title">
                        <li class="layui-this">上传节目</li>
                    </ul>
                </div>
            </div>
            <!-- 警告框 -->
            <div class="rule">
                请您遵守国家相关规定，切勿上传低俗色情、暴力恐怖、谣言诈骗、侵权盗版等相关内容，火把保有依据国家规定及平台规则进行处理的权利。
            </div>
            <!-- 内容主体区域 -->
            <form class="layui-form " action="javascript:void(0);">
                <div style="padding: 15px; background-color: #fff;margin: 10px 15px 0 10px;">
                    <div class="titleTop">
                        专辑基本信息
                    </div>
                    <!-- 基本信息 -->
                    <div class="etc-picture">
                        <div class="df">
                            <div class="prompt">上传至专辑：</div>
                            <div class="pic-one">
                                <img src="https://file.mhuoba.com/shop/3/100021/picture/book/20191108/17/20191108173351194.jpg" alt="">
                            </div>
                            <div style="margin-left:20px;">
                                <div class="etcName">阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园阿狸·旋木花园</div>
                            </div>
                        </div>
                        <div class="uploadFile">
                            <div class="uploadTitle">选择上传文件：</div>
                            <button type="button" class="layui-btn layui-btn-warm" id="upload_file">+选择文件</button>
                            <div class="uploadPro">请选择2G以内MP3、M4A、MP4文件。</div>
                        </div>
                        <div class="uploadContent" id="demoList">
                            <!--<div class="list df">
                                <div class="tally">
                                    <div class="tallyValue">1</div>
                                    <div class="tallySign">、</div>
                                </div>
                                <div class="etcContent textOverflow">
                                    <div class="name textOverflow">
                                        青少年英语大赛练习.MP3
                                    </div>
                                </div>
                                <div class="area">
                                    <span class="mb">7.3MB</span>
                                    <span class="sign">MP3</span>
                                </div>
                                <div class="uploadText">
                                    <span class="text">已上传</span>
                                </div>
                            </div>-->
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="bottom-layui-btn" style="margin-left: 190px;">
        <button type="button" class="layui-btn layui-btn-six">下一步</button>
    </div>
    <!-- 底部 -->
    <div class="layui-footer"></div>
</div>
</body>

</html>
<script type="text/javascript" src="layui-2.0/layui.js"></script>
<script type="text/javascript" src="layui-2.0/jquery3.4.1.js"></script>
<script src="layui-2.0/js/webuploader/webuploader.nolog.min.js"></script>
<script type="text/javascript" src="layui-2.0/public.js"></script>
<script type="text/javascript">

    //全局上传失败
    var fileError = [];

    layui.use(['element', 'form'], function () {
        var element = layui.element,
        layer = layui.layer,
        $ = layui.$;
        var upload = layui.upload;
        var form = layui.form;

        var fileMd5;
        //监听分块上传过程中的三个时间点
        WebUploader.Uploader.register({
            "before-send-file":"beforeSendFile",
            "before-send":"beforeSend",
            "after-send-file":"afterSendFile",
        },{
            //时间点1：所有分块进行上传之前调用此函数
            beforeSendFile:function(file){
                var deferred = WebUploader.Deferred();
                //1、计算文件的唯一标记，用于断点续传
                (new WebUploader.Uploader()).md5File(file,0,10*1024*1024)
                    .progress(function(percentage){
                        // $('#item1').find("p.state").text("正在读取文件信息...");
                    })
                    .then(function(val){
                        fileMd5=val;
                        // $('#item1').find("p.state").text("成功获取文件信息...");
                        //获取文件信息后进入下一步
                        deferred.resolve();
                    });
                return deferred.promise();
            },
            //时间点2：如果有分块上传，则每个分块上传之前调用此函数
            beforeSend:function(block){
                var deferred = WebUploader.Deferred();
                // 同步校验，防止没校验完就上传了
                $.ajaxSetup({async : false});
                $.ajax({
                    type:"POST",
                    url:"/webuploader/checkbreakpoint",
                    data:{
                        //文件唯一标记
                        fileMd5:fileMd5,
                        //当前分块下标
                        chunk:block.chunk,
                        //当前分块大小
                        chunkSize:block.end-block.start,
                        chunks:block.chunks
                    },
                    dataType:"json",
                    success:function(response){
                        if(response.ifExist==1){
                            //分块存在，跳过
                            deferred.reject();
                        }else{
                            //分块不存在或不完整，重新发送该分块内容
                            deferred.resolve();
                        }
                    }
                });
                $.ajaxSetup({async : true});
                this.owner.options.formData.fileMd5 = fileMd5;
                deferred.resolve();
                return deferred.promise();
            },
            //时间点3：所有分块上传成功后调用此函数
            afterSendFile:function(file){
                //如果分块上传成功，则通知后台合并分块
                $.post("/webuploader/vmerge", { fileMd5: fileMd5, fileName: file.name, opt_type: 'package',file_type: 'File', brand_id: brand_id }, function (data) {
                    var data = eval("("+data+")");
                    if (data.code=="0") {
                        element.progress('progress_'+file.id , '100%');
                        var str = '';
                        str += '<div class="sortBox" data-url="'+data.url+'" style="opacity: 0;display: flex;">'+
                            '<div class="up" style="flex-grow: 1;padding-right: 10px;">'+
                            '<i class="layui-icon layui-icon-up" style="font-size: 12px;">上移</i>'+
                            '</div>'+
                            '<div class="down" style="flex-grow: 1;padding-right: 10px;">'+
                            '<i class="layui-icon layui-icon-down" style="font-size: 12px;">下移</i>'+
                            '</div>'+
                            '<div class="close" style="flex-grow: 1;padding-right: 10px;">'+
                            '<i class="layui-icon layui-icon-delete" style="font-size: 12px;">删除</i>'+
                            '</div>'+
                            '</div>';
                        $('#upload-'+file.id).find('.message').html(str);
                        $('#upload-'+file.id).find('.right').removeClass('text');
                    }else if(data.code=="1000"){
                        layer.msg(data.msg);
                        $('#upload-'+file.id).find('.message').text('重新上传');
                        if($('#upload-'+file.id).find('.message').text() == '重新上传'){
                            $('#upload-'+file.id).find('.message').addClass('pause');
                            $('#upload-'+file.id).find('.message').css("color","#F05654");
                            $('#upload-'+file.id).find('.progress-red').css("background","#F05654");
                            $('#upload-'+file.id).find('.right').addClass('text');
                        }
                    }
                });
            }
        });
        var _extensions = 'pdf,doc,docx,xls,xlsx,ppt,pptx,rar,zip';
        var _mimeTypes = 'file/pdf,file/doc,file/docx,file/xls,file/xlsx,file/ppt,file/pptx,file/rar,file/zip';
        var GUID = WebUploader.Base.guid();//一个GUID
        var uploader = WebUploader.create({
            swf: '<?php echo $STYLE_URL; ?>/js/webuploader/Uploader.swf',
            server: "/webuploader/vupload",
            pick: {
                id: '#upload_file',
                innerHTML: '上传文件',
                multiple: true
            },
            resize: false,
            chunked: true,//开始分片上传
            chunkSize: 2*1024*1024,//每一片的大小
            accept: {
                title: '上传文件',
                extensions: _extensions,
                mimeTypes: _mimeTypes
            },
            fileNumLimit: 10,//文件上传数量限制
            fileSingleSizeLimit: 200 * 1024 * 1024,
            threads: 1,
            auto: true,
            formData: {
                guid: GUID //自定义参数，待会儿解释
            }
        });
        uploader.on('beforeFileQueued', function (file) {
            var name=file.name;
            var strs= new Array(); //定义一数组
            strs=name.split(".");
            if(strs[0].length>50){
                layer.msg('文件名称不能超过50字');
                return false;
            }
        });
        uploader.on('fileQueued', function (file) {
            fileError.push(file);
            var _number = $('#demoList .list').length;
            var nums = $('#demoList .list').length;
            var str = '<div class="list df" id="upload-' + file.id + '">';
            str += '<div class="tally">';
            str += '<div class="tallyValue">' + (_number+1) + '</div>';
            str += '<div class="tallySign">、</div>';
            str += '</div>';
            str += '<div class="etcContent textOverflow">';
            str += '<div class="name textOverflow">' + file.name + '</div>';
            str += '</div>';
            str += '<div class="area">';
            str += '<span class="mb">' + (file.size / 1024 / 1024).toFixed(2) + 'MB</span>';
            str += '<span class="sign">&nbsp;MP3</span>';
            str += '</div>';
            str += '<div class="uploadText">';
            str += '<span class="text">上传中...</span>';
            str += '</div>';
            str += '</div>';
            $('#demoList').append(str);
            $('#upload-'+file.id).find('.right').addClass('text');
            $('#file_number').text(_number+1);
        });
        uploader.on('uploadStart', function (file) {
            var addEditSure = "<?php echo $info['goods_id']; ?>";
            if(addEditSure != ""){
                var _number = $('#demoList li').length;
                var numbers = _number-1;
                element.progress('progress_'+file.id , '0%');
                $('#upload-'+file.id).find('.message').text('上传中...');
                $('#upload-'+file.id).find('.right').addClass('text');
            }else{
                var _number = $('#demoList li').length;
                var numbers = _number-1;
                element.progress('progress_'+file.id , '0%');
                $('#upload-'+file.id).find('.message').text('上传中...');
                $('#upload-'+file.id).find('.right').addClass('text');
            }
        });

        uploader.on('uploadProgress', function (file, percentage) {
            console.log("进度：" + percentage + '%');
            if(percentage==1){
                percentage=0.98;
            }
            element.progress('progress_'+file.id , parseInt(percentage * 100) + '%');
        });

        uploader.on('uploadSuccess', function () {
            console.log("进度：100%");
        });
        uploader.on('uploadError', function (file) {
            $('#upload-'+file.id).find('.message').text('重新上传');
            if($('#upload-'+file.id).find('.message').text() == '重新上传'){
                $('#upload-'+file.id).find('.message').addClass('pause');
                $('#upload-'+file.id).find('.message').css("color","#F05654");
                $('#upload-'+file.id).find('.progress-red').css("background","#F05654");
                $('#upload-'+file.id).find('.right').addClass('text');
            }
        });
        uploader.on("error",function (type){
            if(type == 'Q_TYPE_DENIED'){
                layer.msg('文件格式有误！');
                return false;
            }
            if(type == "F_DUPLICATE"){
                layer.msg('请不要重复选择文件！');
                return false;
            }else if(type == "F_EXCEED_SIZE"){
                //layer.msg('所选附件总大小不可超过'+allMaxSize+'M');
                layer.msg("文件大小不能超过200M");
                return false;
            }else if(type == "Q_EXCEED_NUM_LIMIT"){
                layer.msg("文件批量上传不能超过10个");
                return false;
            }
        });
    });
</script>
